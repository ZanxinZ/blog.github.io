<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Concurrency | CodePaper</title><meta name=keywords content="编程语言"><meta name=description content="Swift has built-in support for writing asynchronous and parallel code in a structured way.
Parallel code means multiple pieces of code run simultaneously.
Concurrency will make the code harder to debug. Swift can help to catch problem at compile time. Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.
listPhotos(inGallery: &#34;Summer Vacation&#34;) { photoNames in let sortedNames = photoNames.sorted() let name = sortedNames[0] downloadPhoto(named: name) { photo in show(photo) } } Keywords:"><meta name=author content><link rel=canonical href=https://1-1.link/post/language/swift/18concurrency/><link crossorigin=anonymous href=/assets/css/stylesheet.6e97a6b79be998515e8c86c68e32a9f7a90e6917f550d2af32568b717f5ca785.css integrity="sha256-bpemt5vpmFFejIbGjjKp96kOaRf1UNKvMlaLcX9cp4U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://1-1.link/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://1-1.link/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://1-1.link/favicon-32x32.png><link rel=apple-touch-icon href=https://1-1.link/apple-touch-icon.png><link rel=mask-icon href=https://1-1.link/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Concurrency"><meta property="og:description" content="Swift has built-in support for writing asynchronous and parallel code in a structured way.
Parallel code means multiple pieces of code run simultaneously.
Concurrency will make the code harder to debug. Swift can help to catch problem at compile time. Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.
listPhotos(inGallery: &#34;Summer Vacation&#34;) { photoNames in let sortedNames = photoNames.sorted() let name = sortedNames[0] downloadPhoto(named: name) { photo in show(photo) } } Keywords:"><meta property="og:type" content="article"><meta property="og:url" content="https://1-1.link/post/language/swift/18concurrency/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-05-08T16:00:40+08:00"><meta property="article:modified_time" content="2022-05-08T16:00:40+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Concurrency"><meta name=twitter:description content="Swift has built-in support for writing asynchronous and parallel code in a structured way.
Parallel code means multiple pieces of code run simultaneously.
Concurrency will make the code harder to debug. Swift can help to catch problem at compile time. Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.
listPhotos(inGallery: &#34;Summer Vacation&#34;) { photoNames in let sortedNames = photoNames.sorted() let name = sortedNames[0] downloadPhoto(named: name) { photo in show(photo) } } Keywords:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":3,"name":"Concurrency","item":"https://1-1.link/post/language/swift/18concurrency/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Concurrency","name":"Concurrency","description":"Swift has built-in support for writing asynchronous and parallel code in a structured way.\nParallel code means multiple pieces of code run simultaneously.\nConcurrency will make the code harder to debug. Swift can help to catch problem at compile time. Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.\nlistPhotos(inGallery: \u0026#34;Summer Vacation\u0026#34;) { photoNames in let sortedNames = photoNames.sorted() let name = sortedNames[0] downloadPhoto(named: name) { photo in show(photo) } } Keywords:","keywords":["编程语言"],"articleBody":"Swift has built-in support for writing asynchronous and parallel code in a structured way.\nParallel code means multiple pieces of code run simultaneously.\nConcurrency will make the code harder to debug. Swift can help to catch problem at compile time. Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.\nlistPhotos(inGallery: \"Summer Vacation\") { photoNames in let sortedNames = photoNames.sorted() let name = sortedNames[0] downloadPhoto(named: name) { photo in show(photo) } } Keywords:\nasync make the function asynchronous. await make function calling synchronous. Defining and Calling Asynchronous Functions The asynchronous functions or methods can run in another new ‘thread’, but we have no need to create a thread to do that, the Swift manage the asynchronous calling automatically.\nfunc listPhotos(inGallery name: String) async -\u003e [String] { let result = // ... some asynchronous networking code ... return result } With the async keyword, the function will be executed in an asynchronous way when it’s been called (the async should be written before throws). The network request takes a relatively long time, so use the we async to let the rest of the app’s code keep running while this code waits for the picture to be ready.\nSuspend Execution by await Use await to make the caller being suspend. Waiting for the return of the function.That code also runs until the next suspension point, marked by await, or until it completes.\nWhile this code’s execution is suspended, some other concurrent code in the same program runs. For example, maybe a long-running background task continues updating a list of new photo galleries.\nlet photoNames = await listPhotos(inGallery: \"Summer Vacation\") let sortedNames = photoNames.sorted() let name = sortedNames[0] let photo = await downloadPhoto(named: name) show(photo) The await make the code to be suspend that also called yielding the thread, so behind the scenes, the other code in the same thread will have opportunity to be executed.\nOnly certain place in the program can call asynchronous function or methods:\nCode in the body of an asynchronous function, method, or property. Code in the static main() method of a structure, class, or enumeration that mark with @main . Code in an unstructured child task. A way to simulate the waiting for network request.\nfunc listPhotos(inGallery name: String) async throws -\u003e [String] { let result = [\"fine\", \"aaa\"] try await Task.sleep(nanoseconds: 5 * 10000) // Use the 'try await Task.sleep' to simulate print(\"did\") return result } func downloadPhoto(names: [String]) async throws { print(\"download\") try await Task.sleep(4 * 1_000_000) } Asynchronous Sequences Suspend every execution of the elements.\nimport Foundation let handle = FileHandle.standardInput for try await line in handle.bytes.lines { print(line) } Calling Asynchronous Functions in Parallel In synchronous way, they are processed one by one.\nlet firstPhoto = await downloadPhoto(named: photoNames[0]) let secondPhoto = await downloadPhoto(named: photoNames[1]) let thirdPhoto = await downloadPhoto(named: photoNames[2]) In asynchronous way, they are processed asynchronously, don’t wait for each mother.\nasync let firstPhoto = downloadPhoto(named: photoNames[0]) async let secondPhoto = downloadPhoto(named: photoNames[1]) async let thirdPhoto = downloadPhoto(named: photoNames[2]) // Async can't be used for the non-async properties. Both await and async-let allow other code to run while they’re suspended. The code can use both await and async-let in a same project. Tasks and Task Groups Structured concurrency Tasks are arranged in a hierarchy. Each task in a task group has the same parent task, and each task can have child tasks. await withTaskGroup(of: Data.self) { taskGroup in let photoNames = await listPhotos(inGallery: \"Summer Vacation\") for name in photoNames { taskGroup.addTask { await downloadPhoto(named: name) } } } Unstructured Concurrency Two way to create unstructured task and get a task handle as the result.\nTo create an unstructured task that runs on the current actor, call the Task.init(priority: operation:) initializer. To create an unstructured task that’s not part of the current actor, call the Task.d etached(priority:operation:) class method. let newPhoto = // ... some photo data ... let handle = Task { return await add(newPhoto, toGalleryNamed: \"Spring Adventures\") } let result = await handle.value Task Cancellation Task check can do some responds when the condition is satisfied. It depended on the work we do.\nThrowing error like cancellationError Returning nil or an empty collection Returning the partially completed work Call Task.checkCancellation() , and it will throws CancellationError if the task has been cancelled. Call Task.isCancelled and handle the cancellation in the code.\nCall Task.cancel() to propagate cancellation manually.\nActors It’s similar to the class. It’s reference type. Allow only one task to access their mutable state at a time.\nWhen a task(A) is interacting with an actor instance, the another task(B) can’t access this actor instance at the same time, and the task B will be suspend and waiting for access the property.\nactor Home{ let label: String var t: [Int] private(set) var max: Int = 0 init(label: String, t: Int) { self.label = label self.t = [t] if t \u003e self.max { self.max = t } } } extension Home{ func update(with temp: Int) { t.append(temp) if temp \u003e max { max = temp } } } Use the actor\n@main struct DemoApp { static func main() async { var home = Home(label: \"Ha\", t: 10) print(await home.max) await home.update(with: 22) print(await home.max) } } ","wordCount":"875","inLanguage":"en","datePublished":"2022-05-08T16:00:40+08:00","dateModified":"2022-05-08T16:00:40+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://1-1.link/post/language/swift/18concurrency/"},"publisher":{"@type":"Organization","name":"CodePaper","logo":{"@type":"ImageObject","url":"https://1-1.link/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://1-1.link accesskey=h title="CodePaper (Alt + H)">CodePaper</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://1-1.link/archive/ title=档案><span>档案</span></a></li><li><a href=https://1-1.link/categories/ title=类别><span>类别</span></a></li><li><a href=https://1-1.link/tags/ title=标签><span>标签</span></a></li><li><a href=https://1-1.link/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://1-1.link/about/ title=关于我><span>关于我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://1-1.link>Home</a></div><h1 class=post-title>Concurrency</h1><div class=post-meta><span title='2022-05-08 16:00:40 +0800 +0800'>May 8, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#defining-and-calling-asynchronous-functions aria-label="Defining and Calling Asynchronous Functions">Defining and Calling Asynchronous Functions</a><ul><li><a href=#suspend-execution-by-await aria-label="Suspend Execution by await">Suspend Execution by <code>await</code></a></li></ul></li><li><a href=#asynchronous-sequences aria-label="Asynchronous Sequences">Asynchronous Sequences</a></li><li><a href=#calling-asynchronous-functions-in-parallel aria-label="Calling Asynchronous Functions in Parallel">Calling Asynchronous Functions in Parallel</a></li><li><a href=#tasks-and-task-groups aria-label="Tasks and Task Groups">Tasks and Task Groups</a><ul><li><a href=#structured-concurrency aria-label="Structured concurrency">Structured concurrency</a></li><li><a href=#unstructured-concurrency aria-label="Unstructured Concurrency">Unstructured Concurrency</a></li><li><a href=#task-cancellation aria-label="Task Cancellation">Task Cancellation</a></li></ul></li><li><a href=#actors aria-label=Actors>Actors</a></li></ul></div></details></div><div class=post-content><p>Swift has built-in support for writing asynchronous and parallel code in a structured way.</p><p>Parallel code means multiple pieces of code run simultaneously.</p><ul><li>Concurrency will make the code harder to debug.</li><li>Swift can help to catch problem at compile time.</li></ul><p>Although it’s possible to write concurrent code without using Swift language support, that code tends to be hard to read.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>listPhotos(inGallery: <span style=color:#e6db74>&#34;Summer Vacation&#34;</span>) { photoNames <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sortedNames = photoNames.sorted()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> name = sortedNames[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    downloadPhoto(named: name) { photo <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        show(photo)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Keywords:</p><ul><li><code>async</code> make the function asynchronous.</li><li><code>await</code> make function calling synchronous.</li></ul><h2 id=defining-and-calling-asynchronous-functions>Defining and Calling Asynchronous Functions<a hidden class=anchor aria-hidden=true href=#defining-and-calling-asynchronous-functions>#</a></h2><p>The asynchronous functions or methods can run in another new ‘thread’, but we have no need to create a thread to do that, the Swift manage the asynchronous calling automatically.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>listPhotos</span>(inGallery name: String) async -&gt; [String] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result = <span style=color:#75715e>// ... some asynchronous networking code ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With the <code>async</code> keyword, the function will be executed in an asynchronous way when it’s been called (the <code>async</code> should be written before <code>throws</code>). The network request takes a relatively long time, so use the we <code>async</code> to let the rest of the app’s code keep running while this code waits for the picture to be ready.</p><h3 id=suspend-execution-by-await>Suspend Execution by <code>await</code><a hidden class=anchor aria-hidden=true href=#suspend-execution-by-await>#</a></h3><p>Use <code>await</code> to make the caller being suspend. Waiting for the return of the function.That code also runs until the next suspension point, marked by <code>await</code>, or until it completes.</p><p>While this code’s execution is suspended, some other concurrent code in the same program runs. For example, maybe a long-running background task continues updating a list of new photo galleries.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> photoNames = await listPhotos(inGallery: <span style=color:#e6db74>&#34;Summer Vacation&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> sortedNames = photoNames.sorted()
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> name = sortedNames[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> photo = await downloadPhoto(named: name)
</span></span><span style=display:flex><span>show(photo)
</span></span></code></pre></div><p>The <code>await</code> make the code to be suspend that also called <em>yielding the thread,</em> so behind the scenes, the other code in the same thread will have opportunity to be executed.</p><p>Only certain place in the program can call asynchronous function or methods:</p><ul><li>Code in the body of an asynchronous function, method, or property.</li><li>Code in the static <code>main()</code> method of a structure, class, or enumeration that mark with <code>@main</code> .</li><li>Code in an unstructured child task.</li></ul><p>A way to simulate the waiting for network request.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>listPhotos</span>(inGallery name: String) async <span style=color:#66d9ef>throws</span> -&gt; [String] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result = [<span style=color:#e6db74>&#34;fine&#34;</span>, <span style=color:#e6db74>&#34;aaa&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> await Task.sleep(nanoseconds: <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10000</span>) <span style=color:#75715e>// Use the &#39;try await Task.sleep&#39; to simulate</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;did&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>downloadPhoto</span>(names: [String]) async <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;download&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> await Task.sleep(<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1_000_000</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=asynchronous-sequences>Asynchronous Sequences<a hidden class=anchor aria-hidden=true href=#asynchronous-sequences>#</a></h2><p>Suspend every execution of the elements.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Foundation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> handle = FileHandle.standardInput
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#66d9ef>try</span> await line <span style=color:#66d9ef>in</span> handle.bytes.lines {
</span></span><span style=display:flex><span>    print(line)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=calling-asynchronous-functions-in-parallel>Calling Asynchronous Functions in Parallel<a hidden class=anchor aria-hidden=true href=#calling-asynchronous-functions-in-parallel>#</a></h2><p>In synchronous way, they are processed one by one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> firstPhoto = await downloadPhoto(named: photoNames[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> secondPhoto = await downloadPhoto(named: photoNames[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> thirdPhoto = await downloadPhoto(named: photoNames[<span style=color:#ae81ff>2</span>])
</span></span></code></pre></div><p>In asynchronous way, they are processed asynchronously, don’t wait for each mother.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>async <span style=color:#66d9ef>let</span> firstPhoto = downloadPhoto(named: photoNames[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>async <span style=color:#66d9ef>let</span> secondPhoto = downloadPhoto(named: photoNames[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>async <span style=color:#66d9ef>let</span> thirdPhoto = downloadPhoto(named: photoNames[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Async can&#39;t be used for the non-async properties.</span>
</span></span></code></pre></div><ul><li>Both <code>await</code> and <code>async</code>-<code>let</code> allow other code to run while they’re suspended.</li><li>The code can use both <code>await</code> and <code>async-let</code> in a same project.</li></ul><h2 id=tasks-and-task-groups>Tasks and Task Groups<a hidden class=anchor aria-hidden=true href=#tasks-and-task-groups>#</a></h2><h3 id=structured-concurrency>Structured concurrency<a hidden class=anchor aria-hidden=true href=#structured-concurrency>#</a></h3><ul><li>Tasks are arranged in a hierarchy. Each task in a task group has the same parent task, and each task can have child tasks.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>await withTaskGroup(of: Data.<span style=color:#66d9ef>self</span>) { taskGroup <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> photoNames = await listPhotos(inGallery: <span style=color:#e6db74>&#34;Summer Vacation&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name <span style=color:#66d9ef>in</span> photoNames {
</span></span><span style=display:flex><span>        taskGroup.addTask { await downloadPhoto(named: name) }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=unstructured-concurrency>Unstructured Concurrency<a hidden class=anchor aria-hidden=true href=#unstructured-concurrency>#</a></h3><p>Two way to create unstructured task and get a task handle as the result.</p><ul><li>To create an unstructured task that runs on the current actor, call the <code>Task.init(priority: operation:)</code> initializer.</li><li>To create an unstructured task that’s not part of the current actor, call the <code>Task.d etached(priority:operation:)</code> class method.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> newPhoto = <span style=color:#75715e>// ... some photo data ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> handle = Task {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> await add(newPhoto, toGalleryNamed: <span style=color:#e6db74>&#34;Spring Adventures&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> result = await handle.value
</span></span></code></pre></div><h3 id=task-cancellation>Task Cancellation<a hidden class=anchor aria-hidden=true href=#task-cancellation>#</a></h3><p>Task check can do some responds when the condition is satisfied. It depended on the work we do.</p><ul><li>Throwing error like <code>cancellationError</code></li><li>Returning <code>nil</code> or an empty collection</li><li>Returning the partially completed work</li></ul><p>Call <code>Task.checkCancellation()</code> , and it will throws <code>CancellationError</code> if the task has been cancelled. Call <code>Task.isCancelled</code> and handle the cancellation in the code.</p><p>Call <code>Task.cancel()</code> to propagate cancellation manually.</p><h2 id=actors>Actors<a hidden class=anchor aria-hidden=true href=#actors>#</a></h2><p>It’s similar to the <code>class</code>. It’s reference type. <strong>Allow only one task to access their mutable state at a time.</strong></p><p>When a task(A) is interacting with an actor instance, the another task(B) can’t access this actor instance at the same time, and the task B will be suspend and waiting for access the property.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>actor Home{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> label: String
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> t: [Int]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span>(<span style=color:#66d9ef>set</span>) <span style=color:#66d9ef>var</span> max: Int = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>init</span>(label: String, t: Int) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>self</span>.label = label
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>self</span>.t = [t]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> t <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>self</span>.max {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>self</span>.max = t
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Home</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>update</span>(with temp: Int) {
</span></span><span style=display:flex><span>        t.append(temp)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> temp <span style=color:#f92672>&gt;</span> max {
</span></span><span style=display:flex><span>            max = temp
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Use the actor</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>@main
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>DemoApp</span> {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() async {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> home = Home(label: <span style=color:#e6db74>&#34;Ha&#34;</span>, t: <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>        print(await home.max)
</span></span><span style=display:flex><span>        await home.update(with: <span style=color:#ae81ff>22</span>)
</span></span><span style=display:flex><span>        print(await home.max)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://1-1.link/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/>编程语言</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Concurrency on twitter" href="https://twitter.com/intent/tweet/?text=Concurrency&amp;url=https%3a%2f%2f1-1.link%2fpost%2flanguage%2fswift%2f18concurrency%2f&amp;hashtags=%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Concurrency on reddit" href="https://reddit.com/submit?url=https%3a%2f%2f1-1.link%2fpost%2flanguage%2fswift%2f18concurrency%2f&title=Concurrency"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Concurrency on telegram" href="https://telegram.me/share/url?text=Concurrency&amp;url=https%3a%2f%2f1-1.link%2fpost%2flanguage%2fswift%2f18concurrency%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://1-1.link>CodePaper</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>